<HTML>

<head>
    <link rel="icon" type="image/png" href="favicon.png" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Skyrover.ai</title>
    <!--load first for menus-->
    <link rel="stylesheet" type="text/css" href="css/menu.css" />
    <!-- jQuery and related libraries first -->
    <script type="text/javascript" src="core/libs/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="core/libs/jquery-ui.js"></script>
    <script type="text/javascript" src="core/libs/bootstrap.min.3.3.6.js"></script>
    <script type="text/javascript" src="core/libs/bootstrap-toggle.min.js"></script>
    <!-- Then other scripts -->
    <script type="text/javascript" src="core/blockly_compressed.js"></script>
    <!-- needed for type of variable -->
    <script type="text/javascript" src="core/Ardublockly/type.js"></script>
    <script type="text/javascript" src="core/Ardublockly/types.js"></script>
    <script type="text/javascript" src="core/Ardublockly/static_typing.js"></script>
    <script type="text/javascript" src="core/Ardublockly/instances.js"></script>
    <script type="text/javascript" src="core/Ardublockly/field_instance.js"></script>
    <script type="text/javascript" src="core/Ardublockly/block_instance.js"></script>
    <!--Arduino generator, must be defined NOW-->
    <script type="text/javascript" src="generators/generator_arduino.js"></script>
    <script type="text/javascript" src="generators/generator_python.js"></script>

    <script type="text/javascript" src="core/BlocklyArduino/blockly@rduino_core_Electron.js"></script>
    <script type="text/javascript" src="core/BlocklyArduino/blockly@rduino_boards.js"></script>
    <script type="text/javascript" src="core/BlocklyArduino/blockly@rduino_functions_buttons_Electron.js"></script>
    <script type="text/javascript" src="core/BlocklyArduino/blockly@rduino_tools.js"></script>
    <script type="text/javascript" src="core/BlocklyArduino/blockly@rduino_visual.js"></script>
    <script type="text/javascript" src="core/BlocklyArduino/blockly@rduino_visual_buttons.js"></script>

    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <script type="text/javascript" src="core/libs/clipboard.min.js"></script>
    <script type="text/javascript" src="core/libs/head.load.min.js"></script>
    <script type="text/javascript" src="core/libs/html2canvas.min.js"></script>
    <script type="text/javascript" src="core/libs/canvas2image.js"></script>
    <script type="text/javascript" src="core/libs/prettify.min.js"></script>
    <script type="text/javascript" src="core/libs/smoothie.js"></script>
    <script>
        if (window.module) module = window.module;
    </script>
    <!-- define all additional blocks from one resumer-->
    <script type="text/javascript" src="blocks/arduino_resume.js"></script>
    <script type="text/javascript" src="generators/arduino_resume.js"></script>

    <!-- define all python & micro:bit-->
    <script type="text/javascript" src="blocks/microbit/microbit.js"></script>
    <script type="text/javascript" src="generators/python_resume.js"></script>

    <script type="text/javascript" src="lang/code.js"></script>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.BlocklyArduino.css" />
    <link rel="stylesheet" type="text/css" href="css/blockly@rduino.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap-toggle.min.css" />
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="css/prettify.css" />
    <link rel="stylesheet" href="css/custom.css">

    <script type="text/javascript">
        $(window).load(function() {
            $(".loading").fadeOut("slow");
        });
    </script>
    <script>
        function maximizePage() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            }
            
            // Maximize the window if possible
            if (window.screen && window.screen.availWidth) {
                window.moveTo(0, 0);
                window.resizeTo(window.screen.availWidth, window.screen.availHeight);
            }
        }
    </script>
    <!-- Add Bootstrap Icons CDN if not already present -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
    #btn_left_bottom {
      position: fixed;
      left: 20px;
      bottom: 20px;
      z-index: 9999;
      background: #990099;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1.1em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #btn_left_bottom:hover {
      background: #7c007e;
      color: #fff;
    }
    
    /* Styling for warning messages */
    .message.warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .message.error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .message.success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .message.info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    </style>
</head>

<body onload="BlocklyDuino.init(); maximizePage();">
    <script>
    // This is the new, correct function for adding messages to the top
    function addNewMessage(message, type = 'info') {
        var messagesOutput = document.getElementById('messagesOutput');
        if (!messagesOutput) return;
        var messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.textContent = message;
        messagesOutput.prepend(messageElement);
    }
    // The old function now calls the new one
    window.addMessage = function(message, type = 'info') {
        addNewMessage(message, type);
    };
    </script>
    <div class="loading"></div>
    <div id="header">
        <div id="logo_Titre">
            <a href="./index.html">
                <img id="clearLink" src="media/BlocklyArduino/logo.png" border="0" height="36" onclick="" />
            </a>
        </div>
        <div id="header_titres">
            <div id="divTitreMenu" class="hidden">
                <div id="divTitreMenu_menu">
                    <nav id="nav_hor">
                        <ul id="main-menu">
                            <li>
                                <a><span id="span_menu_1"> </span> <i class="fa fa-caret-down"></i></a>
                                <ul class="submenu">
                                    <li>
                                        <a href="#" id="menu_11"> <span id="span_menu_11"> </span> </a>
                                    </li>
                                    <li>
                                        <a href="#" id="menu_12"> <span id="span_menu_12"> </span> </a>
                                    </li>
                                    <li>
                                        <a id="menu_13"> <span id="span_menu_13"> </span> <i class="fa fa-caret-right"></i></a>
                                        <ul class="submenu">
                                            <li>
                                                <a href="#" id="menu_131" data-toggle="modal" data-target="#exampleModal"> <span id="span_menu_131"> </span> </a>
                                            </li>
                                            <li>
                                                <a href="#" id="menu_132" target="_blank"> <span id="span_menu_132"> </span> </a>
                                            </li>
                                            <li>
                                                <a href="https://github.com/technologiescollege/BlocklyArduino-example" id="menu_133" target="_blank"> <span id="span_menu_133"> </span> </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                <a href="/tutorials.html" id="btn_menu_tutorials" target="_blank">
                                    <span id="span_menu_tutorials">TUTORIALS</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="btn_menu_about" data-toggle="modal" data-target="#aboutModal">
                                    <span id="span_menu_6"> </span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            <!--div id="divTitre">
                <div id="btn_levels">
                    <a href="#" id="toolbox_algo" class="btn btn-level btn-default" role='button'>0</a>
                    <a href="#" id="toolbox_arduino_1" class="btn btn-level btn-default" role='button'>1</a>
                    <a href="#" id="toolbox_arduino_2" class="btn btn-level btn-default" role='button'>2</a>
                    <a href="#" id="toolbox_arduino_3" class="btn btn-level btn-default" role='button'>3</a>
                    <a href="#" id="toolbox_arduino_4" class="btn btn-level btn-default" role='button'>4</a>
                    <a href="#" id="toolbox_arduino_all" class="btn btn-level btn-default" role='button'>TOUT</a>
                    <label id="labelToolboxDefinition"></label>
                </div>
            </div> -->
            <div id="divTitreMenu_miniCard">
                <!--a href="#" id="miniCard_Menu">
                    <img id="arduino_card_miniPicture_Menu" height="36" border="0" />
                </a-->
            </div>
        </div>
        <div id="sideSerialControls" class="serial-controls">
            <button id="btn_boards_modal" data-toggle="modal" data-target="#boardsModal">Boards</button>
            <span id="side_board_name_measure" style="visibility:hidden;position:absolute;white-space:pre;font-weight:bold;font-size:1em;font-family:inherit;"></span>
            <select id="side_serialport" class="serial-dropdown"><option value="COM8">COM8</option></select>
            <button id="side_btn_upload" class="btn btn-success">Upload</button>
        </div>
        <div id="header_code" class="hidden-section">
            <div id="barre_ide">
                <button id="btn_edit_code" class="btn btn-arduinoRect" data-toggle="modal" data-target="#editModal"></button>
                <button id="btn_saveArduino" class="btn btn-arduinoRect"></button>
                <button id="btn_verify_local" class="btn btn-arduino">&#10003;</button>
                <select id="serialport_ide" class="synchCOMport"></select>
                <button id="btn_flash_local" class="btn btn-arduino">&#8594;</button>
                <button id="btn_term" class="btn btn-arduinoRect"></button>
                <span id="survol" style="color:white"></span>
            </div>
        </div>
        <div id="header_supervision" class="hidden-section">
            <div id="barre_supervision">
                <select id="serialport_sup" class="synchCOMport">
						<option value="no_com" selected>port</option>
					</select>
                <span id="span_pymata_upload_text" style="color:white"></span>
                <button id="btn_flash_pymata" class="btn btn-arduino">
						<span class="fas fa-arrow-right fa-1_5x fa-fw"> </span>
                        <span id="span_flash_pymata"> </span>
					</button>
                <span id="span_pymata_toggle_text" style="color:white"></span>
                <button id="toggle-pymata" class="btn btn-arduino">
						<span class="fas fa-arrow-right fa-1_5x fa-fw"> </span>
                        <span id="span_flash_pymata"> </span>
					</button>
                <!-- <input id="toggle-pymata" data-toggle="toggle" data-off="<span id='span_pymataOFF'> </span>" data-on="<span id='span_pymataON'> </span>" data-onstyle="primary" data-offstyle="default" data-width="120" type="checkbox"/> -->
                <span id="sup_debug" style="color:white"></span>
            </div>
        </div>
    </div>
    <div id="mainContent">
        <!-- Nav tabs -->
        <div id="divTabpanel" role="tabpanel">
            <!-- Tab panes -->
            <div id="content_area" class="tab-content">
                <div id="content_blocks" class="tab-pane active" style="position: relative;">
                    <button id="btn_delete" class="btn btn-danger">
                            <span class="glyphicon glyphicon-erase"> </span>
                            <span id="span_delete"> </span>
                        </button>
                </div>
                <div id="content_arduino" class="tab-pane">
                    <div id="barre_h">
                        <div id="checkDetails">
                            <input type="checkbox" name="detailedCompilation" id="detailedCompilation" /> <span id="span_detailedCompilation" style="color: white;"> </span>
                        </div>
                    </div>
                    <div id="local_debug"></div>
                    <div id="barre"></div>
                </div>
                <div id="content_supervision" class="tab-pane">
                </div>
            </div>
        </div>
    </div>
    <div id="sidePreview">
        <div class="arduino-preview-container">
            <pre id="pre_previewArduino" title="Source code"></pre>
            <button id="previewExpandBtn" aria-label="Expand preview" title="Expand preview" type="button" data-toggle="modal" data-target="#sideExpandModal">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
        </div>
        <div class="serial-tabs">
            <button class="serial-tab-btn active" data-tab="messages">Messages</button>
            <button class="serial-tab-btn" data-tab="serial">Serial</button>
        </div>
        <div id="messagesMonitor" class="serial-monitor">
            <pre id="messagesOutput" class="serial-output"></pre>
        </div>
        <div id="serialMonitor" class="serial-monitor">
            <div class="serial-monitor-row">
                <div class="serial-monitor-top">
                    <button id="side_btn_connect_monitor" class="btn serial-btn-connect">Serial On</button>
                    <select id="baudRateSelect" class="serial-baudrate">
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select>
                    <button id="serialExpandBtn" class="btn serial-btn-send" type="button" data-toggle="modal" data-target="#serialExpandModal">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
                <div class="serial-monitor-bottom">
                    <input id="serialInput" type="text" placeholder="Type to send..." class="serial-input">
                    <button id="serialSendBtn" class="btn serial-btn-send"><span class="fa fa-paper-plane"></span></button>
                </div>
            </div>
            <pre id="serialOutput" class="serial-output"></pre>
        </div>
    </div>
    <!-- Modals -->
    <!-- about modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                    <h4>
                        <span class="glyphicon glyphicon-user"> </span>
                        <label class="modal-title" id="aboutModalLabel" />
                    </h4>
                </div>
                
                <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <a href="https://github.com/basheerbk/blockide" target="_blank" class="btn btn-primary">
                                    <span class="glyphicon glyphicon-new-window"></span>
                                    Visit GitHub Repository
                                </a>
                    </div>
                </div>
            </div>
                    <br />
                    <br />
                    <div align="center" id="paypal_about">
                       
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ajax modal -->
    <div class="modal fade" id="ajaxModal" tabindex="-1" role="dialog" aria-labelledby="ajaxModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                    <h4 class="modal-title" id="ajaxModalLabel"></h4>
                </div>
                <div class="modal-body">
                    <pre id="msg_ajax_ko"></pre>
                    <input type="checkbox" name="ajax_msg" id="ajax_msg" /> <span id="span_ajax_msg"> </span>
                </div>
                <div class="modal-footer">
                    <button id="btn_close_msg" type="button" class="btn btn-default" data-dismiss="modal"></button>
                    <button id="btn_valid_msg" type="button" class="btn btn-primary"></button>
                </div>
            </div>
        </div>
    </div>
    <!-- picture modal -->
    <div id="pictureModalLabel" style="display:none">
        <div id="pictureModalLabel_boutons">
            <button id="btn_card_picture_mini" class="btn btn-default">
                    <span id="icon_btn_blocs_picture_mini" class="glyphicon glyphicon-minus"> </span>
                </button>
            <button id="btn_card_picture_maxi" class="btn btn-default">
                    <span id="icon_btn_blocs_picture_maxi" class="glyphicon glyphicon-plus"> </span>
                </button>
            <button id="btn_card_picture_change" class="btn btn-primary btn-sm">
                    <span id="span_card_picture_change"> </span>
                </button>
        </div>
        <div id="board_select_AIO_on"></div>
        <div id="arduino_card_picture_inModal">
            <img id="arduino_card_picture" width="200" />
        </div>
    </div>
    <!-- example modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel"></h4>
                    <b><a href="https://github.com/basheerbk/blockide"><i class="fab fa-github" aria-hidden="true"></i> Github </a></b>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <tbody id="includedContent">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- show wiring of example "modal" -->
    <div id="wiringModal" class="modal-dialog" style="display:none;width: 100%;">
        <div id="pictureModalLabel_boutons">
            <button id="btn_wiring_mini" class="btn btn-default">
                    <span id="icon_btn_blocs_picture_mini" class="glyphicon glyphicon-minus"> </span>
                </button>
            <button id="btn_wiring_maxi" class="btn btn-default">
                    <span id="icon_btn_blocs_picture_maxi" class="glyphicon glyphicon-plus"> </span>
                </button>
        </div>
        <div id="wiringModal_picture" class="modal-dialog" style="width: 100%;">
        </div>
    </div>
    <!-- convert bin <-> text "modal" -->
    <div id="convertModal" class="modal-dialog" style="display:none">
        <input id="ti1" value="TEST" />
        <button onclick="BlocklyDuino.text2bin();"><span id="span_txt2bin"> </span></button>
        <input id="ti2" />
        <br/>
        <input id="ti3" value="01010101" />
        <button onclick="BlocklyDuino.bin2text();"><span id="span_bin2txt"> </span></button>
        <input id="ti4" />
    </div>
    <!-- create char for LCD code "modal" -->
    <div id="screen_falsemodal" style="display:none">
        <iframe frameborder="0" marginwidth="0" marginheight="0">
            </iframe>
    </div>
    <!-- convert RGB color code "modal" -->
    <div id="RGB_falsemodal" style="display:none">
        <iframe frameborder="0" marginwidth="0" marginheight="0">
            </iframe>
    </div>
    <!-- toolbox config modal -->
    <div class="modal fade" id="configModal" tabindex="-1" role="dialog" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                    <h4>
                        <span class="fa fa-cogs"> </span>
                        <label class="modal-title" id="configModalLabel" />
                    </h4>
                    <div id="div_toolboxes">
                        <select id="toolboxes">
                                <option value="toolbox_none">...</option>
                                <option value="toolbox_algo"></option>
                                <option value="toolbox_arduino_1"></option>
                                <option value="toolbox_arduino_2"></option>
                                <option value="toolbox_arduino_3"></option>
                                <option value="toolbox_arduino_4"></option>
                                <option value="toolbox_arduino_all" selected="selected"></option>
                            </select>
                    </div>
                    <br />
                    <br />
                    <label id="span_functionToggle"> </label>
                    <input id="toggle-Functions" data-toggle="toggle" data-off="<span id='span_functionON'> </span>" data-on="<span id='span_functionOFF'> </span>" data-onstyle="primary" data-offstyle="default" data-width="120" type="checkbox" />
                </div>
                <input type="checkbox" name="select_all" id="select_all" /> <span id="span_select_all"> </span>
                <div class="modal-body" id="modal-body-config"></div>
                <div class="modal-footer">
                    <button id="btn_close_config" type="button" class="btn btn-default" data-dismiss="modal"></button>
                    <button id="btn_valid_config" type="button" class="btn btn-primary"></button>
                </div>
            </div>
        </div>
    </div>
    <!-- edit code modal -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                    <h4 class="modal-title" id="editModalLabel"></h4>
                </div>
                <div class="modal-body" id="modal-body-code">
                    <textarea id="edit_code" rows="20" cols="85"></textarea>
                </div>
                <div class="modal-footer">
                    <button id="btn_closeCode" type="button" class="btn btn-default" data-dismiss="modal"></button>
                    <button id="btn_validCode" type="button" class="btn btn-primary" data-dismiss="modal"></button>
                </div>
            </div>
        </div>
    </div>
    <!-- global config modal -->
    <div class="modal fade" id="configModalGlobal" tabindex="-1" role="dialog" aria-labelledby="configModalGlobalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                    <h4>
                        <span class="glyphicon glyphicon-alert"> </span>
                        <label class="modal-title" id="configModalGlobalLabel" />
                    </h4>
                </div>
                <div class="modal-body" id="modal-body-config-global">
                    <div class="arduino_card_mini_picture_div">
                        <img id="arduino_card_mini_picture" />
                    </div>
                    <div class="modal-body-config-global_left">
                        <div id="divCard">
                            <br />
                            <span class="fa fa-microchip"></span> <label id="labelArduinoCard"></label>
                            <div id="board_select_AIO_off"></div>
                            <select id="board_select" onmousemove="BlocklyDuino.cardPicture_change_AIO()" onchange="BlocklyDuino.cardPicture_change_AIO()">
                                    <option value="none">...</option>
                                    <optgroup label="Arduino">
                                        <option value="arduino_leonardo">Arduino/Genuino LEONARDO</option>
                                        <option value="arduino_mega">Arduino/Genuino MEGA 2560</option>
                                        <option value="arduino_micro">Arduino/Genuino MICRO</option>
                                        <option value="arduino_mini">Arduino/Genuino MINI ATmega328</option>
                                        <option value="arduino_nano">Arduino/Genuino NANO ATmega328</option>
                                        <option value="arduino_pro8">Arduino/Genuino Pro Mini 3.3V ATmega328</option>
                                        <option value="arduino_pro16">Arduino/Genuino Pro Mini 5V ATmega328</option>
                                        <option value="arduino_uno">Arduino/Genuino UNO</option>
                                        <option value="arduino_yun">Arduino/Genuino YUN</option>
                                        <option value="lilypad">LilyPad ATmega328P</option>
                                    </optgroup>
                                    <optgroup label="DAGU">
                                        <option value="dagu_rs027">Dagu RS027</option>
                                        <option value="dagu_rs040">Dagu RS040</option>
                                    </optgroup>
                                    <optgroup label="Makeblok">
                                        <option value="makeblock_mcore">mBot/mCore</option>
                                        <option value="makeblock_megaPi">MegaPi</option>
                                        <option value="makeblock_orion">Orion</option>
                                    </optgroup>
                                    <optgroup label="DFRobot">
                                        <option value="dfrobot_romeo">DFRobot RoMeo v2</option>
                                        <option value="dfrobot_romeo_ble">DFRobot RoMeo BLE</option>
                                    </optgroup>
                                    <optgroup label="ESP">
                                        <option value="esp8266">ESP8266</option>
                                        <option value="esp32">ESP32</option>
                                    </optgroup>
                                    <optgroup label="Otto">
                                        <option value="kit_otto_diy">Otto DIY</option>
                                    </optgroup>
                                    <optgroup label="Peguino">
                                        <option value="peguino_uno_esp32">Peguino Uno ESP32</option>
                                        <option value="peguino_uno_nano">Peguino Uno Nano</option>
                                        <option value="kit_peguino_bot1">Peguino Bot 1</option>
                                    </optgroup>
                                    <optgroup label="Teensy">
                                        <option value="teensy2">Teensy 2.0</option>
                                        <option value="teensy2pp">Teensy++ 2.0</option>
                                    </optgroup>
                                    <optgroup label="Robobox">
                                        <option value="kit_robobox_1_1">mini-alarme v1</option>
                                        <option value="kit_robobox_2_1">bras articulé v1</option>
                                        <option value="kit_robobox_3_1">robot chien v1</option>
                                        <option value="kit_robobox_4_1">robot voiture v1</option>
                                        <option value="kit_robobox_1_2">mini-alarme v2</option>
                                        <option value="kit_robobox_2_2">bras articulé v2</option>
                                        <option value="kit_robobox_3_2">robot chien v2</option>
                                        <option value="kit_robobox_4_2">robot voiture v2</option>
                                        <option value="kit_robobox_5_2">robot voiture v2</option>
                                    </optgroup>
                                    <optgroup label="Kits">
                                        <option value="kit_grove_beginner">Grove Beginner Kit</option>
                                        <option value="kit_crowtail_arduino">Crowtail Starter Kit for Arduino</option>
                                        <option value="kit_microfeux">Micro-feux Jeulin</option>
                                        <option value="kit_petitbot">Petit Bot</option>
                                    </optgroup>
                                    <optgroup label="MicroBit">
                                        <option value="kit_microbit">Micro:bit</option>
                                    </optgroup>
                                    <optgroup label="COG">
                                        <option value="kit_microsaurus">MicroSaurus</option>
                                        <option value="kit_micromachine">MicroMachine</option>
                                    </optgroup>
                                </select>
                        </div>
                        <br />
                        <br />
                        <br />
                        <div id="div_help_button">
                            <button id="btn_videos" class='btn btn-success btn-info text-left'>
                                    <span class="fa fa-film"> </span>
                                </button>
                            <a id="btn_doc" class='btn btn-success btn-info text-left' href="http://www.libreduc.cc/wiki/doku.php/fr/arduino/blockly_rduino" target="_blank" role='button'>
                                <span class="glyphicon glyphicon-info-sign"></span>
                            </a>
                            <a id="btn_tuto" class='btn btn-success btn-info text-left' href="http://blockly.technologiescollege.fr/forum/" target="_blank" role='button'>
                                <span class="glyphicon glyphicon-question-sign"></span>
                            </a>
                        </div>
                        <br />
                        <br />
                        <br />
                        <!-- <div id="div_accessibility_button"> -->
                        <!-- <button id="btn_font" class="btn btn-warning"> -->
                        <!-- <span class="glyphicon glyphicon-text-height"> </span> -->
                        <!-- </button> -->
                        <!-- <button id="btn_colors" class="btn btn-warning jscolor {valueElement:null,value:'F0AD4E'}" onchange="update(this.jscolor)"> -->
                        <!-- <span class="glyphicon glyphicon-tint"> </span> -->
                        <!-- </button> -->
                        <!-- </div> -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="btn_saveConfigGlobale_id">
                        <button id="btn_saveConfigGlobale" type="button" class="btn btn-success" style="position: absolute;left: 15px;"></button>
                    </div>
                    <div id="btn_validConfigGlobale_id">
                    <button id="btn_validConfigGlobale" type="button" class="btn btn-primary" data-dismiss="modal"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- variable modal -->
    <div class="modal fade" id="variableModal" tabindex="-1" role="dialog" aria-labelledby="variableModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body" id="modal-body-variableModal">
                    <div class="form-group">
                        <div id="variableModalLabel" class="modal-title"><label></label></div>
                        <div class="input-group input-group-md icon-addon addon-md">
                            <input type="text" class="form-control" id="var_name" />
                            <span class="input-group-btn">
                                    <button id="btn_variable" type="button" class="btn btn-info" data-dismiss="modal"></button>
                                </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- message modal -->
    <div class="modal fade" id="message" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="messageDIV"> </div>
                </div>
            </div>
        </div>
    </div>
    <!--only for IDE mode -->
    <div id="wiring_dialog">
        <iframe frameborder="0" marginwidth="0" marginheight="0">
            </iframe>
    </div>
    <div id="arduino_IDE_code"> </div>
    <!-- Backend Warning Modal -->
    <div class="modal fade" id="backendWarningModal" tabindex="-1" role="dialog" aria-labelledby="backendWarningLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content" style="background: #ffcccc;">
          <div class="modal-header">
            <h5 class="modal-title" id="backendWarningLabel" style="color: #900;">
               Backend server not reachable
            </h5>
          </div>
          <div class="modal-body" style="color: #900;">
            Compile, upload, and serial features will not work.<br>
            Please make sure you are running <code>python server.py</code> on your local machine.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
    <script>
    // Robust error handling for missing dependencies and profile
    $(document).ready(function() {
        if (typeof $ === 'undefined') {
            alert('jQuery is not loaded. Please check your script includes.');
        }
        if (typeof profile === 'undefined' || !profile.defaultBoard || !profile.defaultBoard['upload_arg']) {
            console.warn('Board profile is not defined. Please select a board.');
        }
        // Ensure button handlers are bound
        $('#btn_verify_local').off('click').on('click', BlocklyDuino.verify_local_Click);
        $('#btn_flash_local').off('click').on('click', BlocklyDuino.uploadClick);
    });
    </script>
    <script>
    // Dynamically determine backend URL
    function getBackendURL() {
        // If running on localhost or 127.0.0.1, use relative path
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return '';
        }
        // If running on GitHub Pages or any remote host, use local backend
        // Use http for localhost backend (user must run backend locally)
        return 'http://localhost:5005';
    }
    const BACKEND_URL = getBackendURL();

    // Show a warning if backend is unreachable
    function showBackendWarning() {
        $('#backendWarningModal').modal('show');
    }

    window.addEventListener('DOMContentLoaded', function() {
        function updateSerialPorts() {
            fetch(BACKEND_URL + '/ports', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(ports => {
                const select = document.getElementById('serialport_ide');
                select.innerHTML = '';
                if (ports.length === 0) {
                    const option = document.createElement('option');
                    option.value = 'no_com';
                    option.textContent = 'No ports detected';
                    select.appendChild(option);
                    select.disabled = true;
                } else {
                    ports.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port;
                        option.textContent = port;
                        select.appendChild(option);
                    });
                    select.disabled = false;
                }
                // Remove warning if backend is reachable
                const warning = document.getElementById('backend-warning');
                if (warning) warning.remove();
            })
            .catch(err => {
                console.warn('Error fetching ports:', err);
                const select = document.getElementById('serialport_ide');
                select.innerHTML = '';
                const option = document.createElement('option');
                option.value = 'no_com';
                option.textContent = 'Error: Backend server not running';
                select.appendChild(option);
                select.disabled = true;
                showBackendWarning();
                addMessage('Backend server not reachable. Compile, upload, and serial features will not work.', 'warning');
            });
        }

        // Initial update
        updateSerialPorts();
        // Update every 2 seconds
        setInterval(updateSerialPorts, 2000);
    });
    </script>
    <script>
    // Remove SVG filter from Blockly bubbles to make them flat/plain
    function removeBlocklyBubbleFilters() {
        document.querySelectorAll('.blocklyBubbleCanvas [filter]').forEach(el => {
            el.removeAttribute('filter');
        });
    }
    // Run after each bubble is created and periodically as a fallback
    setInterval(removeBlocklyBubbleFilters, 500);
    </script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
    (function() {
        const BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? ''
            : 'http://localhost:5005';
        // Elements
        const portSelect = document.getElementById('side_serialport');
        const connectBtn = document.getElementById('side_btn_connect_monitor');
        const uploadBtn = document.getElementById('side_btn_upload');
        const serialInput = document.getElementById('serialInput');
        const serialSendBtn = document.getElementById('serialSendBtn');
        const baudRateSelect = document.getElementById('baudRateSelect');
        let serialConnected = false;
        let connectedPort = null;
        // Create the socket ONCE
        const socket = io(BACKEND_URL || undefined);

        let isConnecting = false;

        function updateUiState() {
            connectBtn.disabled = isConnecting;
            uploadBtn.disabled = serialConnected || isConnecting;
            portSelect.disabled = serialConnected || isConnecting;
            baudRateSelect.disabled = serialConnected || isConnecting;
            serialInput.disabled = !serialConnected;
            serialSendBtn.disabled = !serialConnected;
            connectBtn.textContent = serialConnected ? 'Serial Off' : 'Serial On';
            if (window.syncModalSerialState) window.syncModalSerialState();
        }

        socket.on('serial_data', function(data) {
            if (serialOutput) {
                serialOutput.textContent += data.data;
                serialOutput.scrollTop = serial.scrollHeight;
            }
            if (modalOutput) {
                modalOutput.textContent += data.data;
                modalOutput.scrollTop = modalOutput.scrollHeight;
            }
        });

        socket.on('disconnect', function() {
            serialConnected = false;
            addMessage('Serial port disconnected.', 'info');
            updateUiState();
        });

        // Helper to update upload button state
        function updateUploadButtonState() {
            uploadBtn.disabled = serialConnected;
        }
        updateUploadButtonState();
        // 1. Populate port dropdown
        function updatePorts() {
            fetch(BACKEND_URL + '/ports')
                .then(res => res.json())
                .then(ports => {
                    portSelect.innerHTML = '';
                    if (!ports.length) {
                        portSelect.innerHTML = '<option value="">No ports</option>';
                        portSelect.disabled = true;
                    } else {
                        ports.forEach(port => {
                            const opt = document.createElement('option');
                            opt.value = port;
                            opt.textContent = port;
                            portSelect.appendChild(opt);
                        });
                        portSelect.disabled = false;
                    }
                })
                .catch(() => {
                    portSelect.innerHTML = '<option value="">Error</option>';
                    portSelect.disabled = true;
                });
        }
        updatePorts();
        setInterval(updatePorts, 2000);
        
        connectBtn.addEventListener('click', () => {
            if (isConnecting) return;

            if (!serialConnected) {
                // --- CONNECT ---
                const port = portSelect.value;
                const baudrate = baudRateSelect.value;
                if (!port || port === "") {
                    addMessage('Please select a valid port.', 'error');
                    return;
                }

                isConnecting = true;
                updateUiState();
                addMessage(`Opening port ${port}...`, 'info');

                socket.timeout(5000).emit('open_serial', { port, baudrate }, (err, response) => {
                    isConnecting = false;
                    if (err) {
                        addMessage('Connection timed out. The port may be stuck or in use.', 'error');
                    } else if (response && response.success) {
                        serialConnected = true;
                        addMessage('Serial port open.', 'success');
                    } else {
                        addMessage('Failed to open port: ' + (response.error || 'Unknown error'), 'error');
                    }
                    updateUiState();
                });
            } else {
                // --- DISCONNECT ---
                isConnecting = true;
                updateUiState();
                addMessage('Closing serial port...', 'info');

                socket.timeout(5000).emit('close_serial', {}, (err, response) => {
                    isConnecting = false;
                    // serialConnected is now set by the 'disconnect' event
                    if (err) {
                        addMessage('Failed to close port cleanly (timeout).', 'error');
                        serialConnected = false; // Force state update on error
                    } else if (response && response.success) {
                        addMessage('Serial port closed.', 'info');
                    } else {
                        addMessage('Failed to close port: ' + (response && response.error ? response.error : 'Unknown error'), 'error');
                        serialConnected = false; // Force state update on error
                    }
                    updateUiState();
                });
            }
        });

        // 3. Upload logic (with auto-disconnect if serial is connected)
        uploadBtn.addEventListener('click', function() {
            function doUpload() {
                const port = portSelect.value;
                if (!port) {
                    addMessage('Upload failed: No port selected', 'error');
                    return;
                }
                const code = document.getElementById('pre_previewArduino').textContent;
                const board = (typeof profile !== 'undefined' && profile.defaultBoard && profile.defaultBoard['upload_arg'])
                    ? profile.defaultBoard['upload_arg']
                    : 'arduino_uno';
                if (!code || !code.trim()) {
                    addMessage('Upload failed: No code to upload', 'error');
                    return;
                }
                addMessage('Uploading to board (' + board + ') on port ' + port + '...', 'info');
                
                // Disable all serial controls during upload
                isConnecting = true;
                updateUiState();

                fetch(BACKEND_URL + '/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, board, port })
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        addMessage('Upload completed successfully!', 'success');
                    } else {
                        addMessage('Upload failed: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    addMessage('Upload failed: ' + err.message, 'error');
                })
                .finally(() => {
                    isConnecting = false;
                    updateUiState();
                });
            }

            if (serialConnected && socket) {
                addMessage('Closing serial port for upload...', 'info');
                socket.emit('close_serial', {}, (err, response) => {
                    if (err || (response && !response.success)) {
                         addMessage('Could not disconnect serial monitor. Upload aborted.', 'error');
                         return;
                    }
                    // Wait a moment for the port to be released before uploading
                    setTimeout(doUpload, 1000);
                });
            } else {
                doUpload();
            }
        });
        serialSendBtn.addEventListener('click', function() {
            const val = serialInput.value;
            if (val && serialConnected) {
                socket.emit('write_serial', { data: val + '\n' });
                serialInput.value = '';
            }
        });
        serialInput.disabled = true;
        serialSendBtn.disabled = true;
    })();
    </script>
    <script>
    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.serial-tab-btn');
        const serialMonitor = document.getElementById('serialMonitor');
        const messagesMonitor = document.getElementById('messagesMonitor');
        const clearMessagesBtn = document.getElementById('clearMessages');
        const messagesOutput = document.getElementById('messagesOutput');
        const serialMonitorRow = document.querySelector('#serialMonitor .serial-monitor-row');

        // Function to switch tabs
        function switchTab(tabName) {
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // Remove active class from both monitors
            serialMonitor.classList.remove('active');
            messagesMonitor.classList.remove('active');

            if (tabName === 'serial') {
                serialMonitor.classList.add('active');
                if (serialMonitorRow) serialMonitorRow.style.display = '';
            } else {
                messagesMonitor.classList.add('active');
                if (serialMonitorRow) serialMonitorRow.style.display = 'none';
            }
        }

        // Add click handlers to tab buttons
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // Clear messages functionality
        if (clearMessagesBtn) {
            clearMessagesBtn.addEventListener('click', () => {
                messagesOutput.textContent = '';
            });
        }

        // Initialize with messages tab active
        switchTab('messages');
        
        // Example messages (you can remove these)
        addMessage('System initialized', 'info');
        addMessage('Ready to connect', 'info');
    });
    </script>
    <!-- Serial Monitor Expand Modal -->
    <div class="modal fade" id="serialExpandModal" tabindex="-1" role="dialog" aria-labelledby="serialExpandModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <div class="serial-monitor-row" style="margin-bottom: 12px;">
              <div class="serial-monitor-top">
                <button id="serialExpandConnectBtn" class="btn serial-btn-connect">Serial On</button>
                <select id="serialExpandBaudRate" class="serial-baudrate">
                  <option value="9600">9600</option>
                  <option value="19200">19200</option>
                  <option value="38400">38400</option>
                  <option value="57600">57600</option>
                  <option value="115200">115200</option>
                </select>
              </div>
              <div class="serial-monitor-bottom">
                <input id="serialExpandInput" type="text" placeholder="Type to send..." class="serial-input">
                <button id="serialExpandSendBtn" class="btn serial-btn-send"><span class="fa fa-paper-plane"></span></button>
              </div>
            </div>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <pre id="serialExpandOutput" class="serial-output"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Code Preview Expand Modal -->
    <div class="modal fade" id="sideExpandModal" tabindex="-1" role="dialog" aria-labelledby="sideExpandModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" style="height:60vh; position:relative; padding-top:48px;">
            <div style="position:relative; height:100%;">
              <button id="sideExpandCopyBtn" style="position:absolute; top:8px; right:10px; z-index:10; background:transparent; border:none; font-size:1.5em; color:#990099; cursor:pointer;" title="Copy to clipboard">
                <i class="bi bi-clipboard"></i>
              </button>
              <pre id="sideExpandOutput" class="serial-output" style="height:100%; min-height:400px; max-height:55vh; font-size:1.2em; margin:0;"></pre>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Serial Expand Modal Sync Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get main and modal elements
        const mainConnectBtn = document.getElementById('side_btn_connect_monitor');
        const modalConnectBtn = document.getElementById('serialExpandConnectBtn');
        const mainBaud = document.getElementById('baudRateSelect');
        const modalBaud = document.getElementById('serialExpandBaudRate');
        const mainInput = document.getElementById('serialInput');
        const modalInput = document.getElementById('serialExpandInput');
        const mainSendBtn = document.getElementById('serialSendBtn');
        const modalSendBtn = document.getElementById('serialExpandSendBtn');
        const mainOutput = document.getElementById('serialOutput');
        const modalOutput = document.getElementById('serialExpandOutput');

        // Sync modal controls when modal is shown
        $('#serialExpandModal').on('show.bs.modal', function() {
            // Sync button text and state
            modalConnectBtn.textContent = mainConnectBtn.textContent;
            modalConnectBtn.disabled = mainConnectBtn.disabled;
            // Sync baud rate
            modalBaud.value = mainBaud.value;
            // Sync output
            modalOutput.textContent = mainOutput.textContent;
            // Sync input
            modalInput.value = mainInput.value;
        });

        // Keep output in sync (when new data arrives)
        const observer = new MutationObserver(() => {
            modalOutput.textContent = mainOutput.textContent;
        });
        observer.observe(mainOutput, { childList: true, characterData: true, subtree: true });

        // When modal connect is clicked, trigger main connect
        modalConnectBtn.addEventListener('click', function() {
            mainBaud.value = modalBaud.value; // sync baud
            mainConnectBtn.click();
        });

        // When modal send is clicked, trigger main send
        modalSendBtn.addEventListener('click', function() {
            mainInput.value = modalInput.value;
            mainSendBtn.click();
            modalInput.value = '';
        });

        // When modal baud changes, sync to main
        modalBaud.addEventListener('change', function() {
            mainBaud.value = modalBaud.value;
        });

        // When modal input changes, sync to main
        modalInput.addEventListener('input', function() {
            mainInput.value = modalInput.value;
        });

        // When serial status changes, update modal controls too
        function syncModalSerialState() {
            modalConnectBtn.textContent = mainConnectBtn.textContent;
            modalConnectBtn.disabled = mainConnectBtn.disabled;
            modalBaud.disabled = mainBaud.disabled;
            modalInput.disabled = mainInput.disabled;
            modalSendBtn.disabled = mainSendBtn.disabled;
        }
        window.syncModalSerialState = syncModalSerialState;
    });
    </script>
    <!-- Code Preview Expand Modal Sync Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get main and modal elements for code preview
        const mainPreview = document.getElementById('pre_previewArduino');
        const modalOutput = document.getElementById('sideExpandOutput');
        const copyBtn = document.getElementById('sideExpandCopyBtn');

        // Sync modal content when modal is shown
        $('#sideExpandModal').on('show.bs.modal', function() {
            // Copy content from main preview to modal
            modalOutput.textContent = mainPreview.textContent;
            
            // Apply syntax highlighting if available
            if (typeof prettyPrintOne === 'function') {
                modalOutput.innerHTML = prettyPrintOne(modalOutput.textContent, 'cpp');
            }
        });

        // Keep modal content in sync when main preview changes
        const observer = new MutationObserver(() => {
            if ($('#sideExpandModal').hasClass('in')) {
                modalOutput.textContent = mainPreview.textContent;
                if (typeof prettyPrintOne === 'function') {
                    modalOutput.innerHTML = prettyPrintOne(modalOutput.textContent, 'cpp');
                }
            }
        });
        observer.observe(mainPreview, { childList: true, characterData: true, subtree: true });

        // Handle copy button functionality
        copyBtn.addEventListener('click', function() {
            const textToCopy = modalOutput.textContent;
            
            // Use modern clipboard API if available
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Show temporary success message
                    const originalTitle = copyBtn.title;
                    copyBtn.title = 'Copied!';
                    copyBtn.style.color = '#28a745';
                    
                    setTimeout(() => {
                        copyBtn.title = originalTitle;
                        copyBtn.style.color = '#990099';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopyTextToClipboard(textToCopy);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(textToCopy);
            }
        });

        // Fallback copy function for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const originalTitle = copyBtn.title;
                    copyBtn.title = 'Copied!';
                    copyBtn.style.color = '#28a745';
                    
                    setTimeout(() => {
                        copyBtn.title = originalTitle;
                        copyBtn.style.color = '#990099';
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        }
    });
    </script>
    <script>
    function updateBoardNameBox() {
        var boardSelect = document.getElementById('board_select');
        var boardNameBox = document.getElementById('side_board_name');
        var measureSpan = document.getElementById('side_board_name_measure');
        if (boardSelect && boardNameBox && measureSpan) {
            var selectedOption = boardSelect.options[boardSelect.selectedIndex];
            var boardName = selectedOption ? selectedOption.text : '';
            boardNameBox.value = boardName;

            // Set the span's text and copy styles
            measureSpan.textContent = boardName || boardNameBox.placeholder || '';
            var style = window.getComputedStyle(boardNameBox);
            measureSpan.style.font = style.font;
            measureSpan.style.fontWeight = style.fontWeight;
            measureSpan.style.fontSize = style.fontSize;
            measureSpan.style.fontFamily = style.fontFamily;
            measureSpan.style.letterSpacing = style.letterSpacing;
            measureSpan.style.padding = style.padding;
            measureSpan.style.border = style.border;

            // Calculate width (add a little extra for padding and border)
            var width = measureSpan.offsetWidth + 20;
            // Set min/max width for usability
            width = Math.max(60, Math.min(width, 200));
            boardNameBox.style.width = width + 'px';
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        var boardSelect = document.getElementById('board_select');
        if (boardSelect) {
            boardSelect.addEventListener('change', updateBoardNameBox);
        }
        updateBoardNameBox();
    });
    </script>
    <script>
    // Patch BlocklyDuino.setArduinoBoard to call updateBoardNameBox after board change
    (function() {
        var origSetArduinoBoard = BlocklyDuino.setArduinoBoard;
        BlocklyDuino.setArduinoBoard = function() {
            var result = origSetArduinoBoard.apply(this, arguments);
            if (typeof updateBoardNameBox === 'function') updateBoardNameBox();
            return result;
        };
    })();
    </script>
    <!-- Boards Modal -->
    <div class="modal fade" id="boardsModal" tabindex="-1" role="dialog" aria-labelledby="boardsModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="boardsModalLabel">Boards</h4>
          </div>
          <div class="modal-body">
            <div class="boards-grid">
              <div class="board-card" data-fqbn="esp32:esp32:esp32s3">
                <img src="media/new_boards/sky.png" alt="Skyrover">
                <div class="board-label">Skyrover</div>
              </div>
              <div class="board-card" data-fqbn="arduino:avr:uno">
                <img src="media/new_boards/arduino_uno.png" alt="Arduino Uno">
                <div class="board-label">Arduino Uno</div>
              </div>
              <div class="board-card" data-fqbn="arduino:avr:mega">
                <img src="media/new_boards/arduino_mega.png" alt="Arduino Mega">
                <div class="board-label">Arduino Mega</div>
              </div>
              <div class="board-card" data-fqbn="arduino:avr:nano">
                <img src="media/new_boards/arduino_nano.png" alt="Arduino Nano">
                <div class="board-label">Arduino Nano</div>
              </div>
              <div class="board-card" data-fqbn="esp32:esp32:esp32">
                <img src="media/new_boards/esp32.png" alt="ESP 32">
                <div class="board-label">ESP 32</div>
              </div>
              <div class="board-card" data-fqbn="esp8266:esp8266:nodemcuv2">
                <img src="media/new_boards/image-2.png" alt="Node MCU">
                <div class="board-label">Node MCU</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
    <script>
    // Ensure 'Arduino All' is always selected by default when config modal opens and on page load
    function setArduinoAllDefault() {
        var toolboxSelect = document.getElementById('toolboxes');
        if (toolboxSelect) {
            toolboxSelect.value = 'toolbox_arduino_all';
        }
        // Set sessionStorage
        sessionStorage.setItem('toolbox', 'toolbox_arduino_all');
        // Set global variable if present
        if (window.BlocklyDuino) {
            BlocklyDuino.selectedToolbox = 'toolbox_arduino_all';
        }
        // Remove toolbox from URL if present
        if (window.location.search.match(/[?&]toolbox=[^&]*/)) {
            var search = window.location.search.replace(/([?&]toolbox=)[^&]*/, '');
            var newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname + search;
            window.history.replaceState({}, document.title, newUrl);
        }
    }
    $(document).ready(function() {
        setArduinoAllDefault();
        $('#configModal').on('show.bs.modal', function () {
            setArduinoAllDefault();
        });
    });
    </script>
    <button id="btn_left_bottom">Advanced Blocks</button>
    <script>
    $(document).ready(function() {
      $('#btn_left_bottom').on('click', function() {
        $('#configModal').modal('show');
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      function setInitialBoard() {
        const defaultCard = document.querySelector('#boardsModal .board-card.selected');
        if (defaultCard) {
          const fqbn = defaultCard.getAttribute('data-fqbn');
          const boardName = defaultCard.querySelector('.board-label').textContent.trim();
          
          // Update button text
          var btn = document.getElementById('btn_boards_modal');
          if (btn) btn.textContent = boardName;

          if (fqbn) {
            fetch(BACKEND_URL + '/set_board', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ board: fqbn })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                console.log('Initial board set:', data.message);
              } else {
                console.error('Failed to set initial board:', data.message);
                addMessage('Error setting initial board: ' + data.message, 'error');
              }
            })
            .catch(err => {
              console.error('Error setting initial board:', err);
              addMessage('Error communicating with backend to set initial board.', 'error');
            });
          }
        }
      }

      // Set the initial board state when the page loads
      setInitialBoard();

      // Delegate click event to all .board-card elements in the boards modal
      document.querySelectorAll('#boardsModal .board-card').forEach(function(card) {
        card.addEventListener('click', function() {
          // Remove 'selected' from all cards
          document.querySelectorAll('#boardsModal .board-card').forEach(function(c) {
            c.classList.remove('selected');
          });
          // Add 'selected' to clicked card
          card.classList.add('selected');
          
          var boardName = card.querySelector('.board-label').textContent.trim();
          var fqbn = card.getAttribute('data-fqbn');
          
          // Update button text
          var btn = document.getElementById('btn_boards_modal');
          if (btn) btn.textContent = boardName;
          
          // Send FQBN to backend
          if (fqbn) {
            fetch(BACKEND_URL + '/set_board', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ board: fqbn })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                console.log('Board set:', data.message);
                addMessage('Board set to ' + boardName, 'success');
              } else {
                console.error('Failed to set board:', data.message);
                addMessage('Error setting board: ' + data.message, 'error');
              }
            })
            .catch(err => {
              console.error('Error setting board:', err);
              addMessage('Error communicating with backend to set board.', 'error');
            });
          }
        });
      });
    });
    </script>
</body>
</HTML>